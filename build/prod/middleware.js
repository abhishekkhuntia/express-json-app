"use strict";var __awaiter=this&&this.__awaiter||function(e,s,a,c){return new(a=a||Promise)(function(r,t){function n(e){try{i(c.next(e))}catch(e){t(e)}}function o(e){try{i(c.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?r(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(n,o)}i((c=c.apply(e,s||[])).next())})},__generator=this&&this.__generator||function(r,n){var o,i,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,i&&(s=2&t[0]?i.return:t[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,t[1])).done)return s;switch(i=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,i=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=n.call(r,a)}catch(e){t=[6,e],i=0}finally{o=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};exports.__esModule=!0;var fs=require("fs"),path=require("path"),express=require("express"),bodyParser=require("body-parser"),InitMiddleWare=function(){function e(e,t,r){var a=this;this.app=e,this.cb=r,this.controllers={},this.initializeMiddleWare=function(){return __awaiter(a,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return this.configContent?[4,this.loadControllersMap(path.resolve(this.srcFolderPath,this.configContent.controllerPath))]:[3,2];case 1:e.sent(),this.dynamicRouterMap(),this.cb&&"function"==typeof this.cb&&this.cb(this),e.label=2;case 2:return[2]}})})},this.dynamicRouterMap=function(){a.configContent&&a.configContent.routes&&Object.keys(a.configContent.routes).forEach(function(e){var n=a.configContent.routes[e],o=a.controllers[n.controller],i=""+a.configContent.basePath+e,s=n.bodyParser?bodyParser.json():function(e,t,r){r()};Object.keys(n.methods).forEach(function(e){if(n&&n.methods&&n.methods[e]&&n.methods[e].methodId&&o[n.methods[e].methodId]&&"function"==typeof o[n.methods[e].methodId]){var t=o[n.methods[e].methodId],r=void 0;switch(e){case"GET":r=a.app.get;break;case"POST":r=a.app.post;break;case"DELETE":r=a.app.delete;break;case"PUT":r=a.app.put}r&&(n.methods[e].secured&&a.securityHandler?r.call(a.app,i,s,a.securityHandler,t):r.call(a.app,i,s,t))}})})},this.setSecurityHandler=function(e){var t;e&&1==Object.keys(e).length&&(t=Object.keys(e)[0])&&"function"==typeof e[t]?(a.securityHeader=t.toLowerCase(),a.securityHandler=e[t]):(console.error("Error setting the security handler!"),process.exit(1))},this.loadControllersMap=function(l){return __awaiter(a,void 0,void 0,function(){var t=this;return __generator(this,function(e){return[2,new Promise(function(a,c){return __awaiter(t,void 0,void 0,function(){var t,r,n,o,i,s;return __generator(this,function(e){switch(e.label){case 0:if(!fs.statSync(l).isDirectory())return[3,7];t=fs.readdirSync(path.join(l)),r=0,e.label=1;case 1:if(!(r<t.length))return[3,6];if(!(n=t[r]).match(/\.js$|\.ts$/))return[3,5];e.label=2;case 2:return e.trys.push([2,4,,5]),o=n.replace(/\.js$|\.ts$/,""),[4,Promise.resolve().then(function(){return require(path.join(l,n))})];case 3:return i=e.sent(),this.controllers[o]=i,[3,5];case 4:return s=e.sent(),console.log("Error initializing ",n," with error ",s),c("Error initializing controller"),[3,5];case 5:return r++,[3,1];case 6:a(),e.label=7;case 7:return c("Missing router map"),[2]}})})})]})})},this.srcFolderPath=t.basePath,this.configPath=path.resolve(this.srcFolderPath,"route-map.json"),this.routerInstance=express.Router(),console.log("ARG PATHS >> ",process.argv),this.loadConfigToMemory(),this.initializeMiddleWare()}return e.prototype.loadConfigToMemory=function(){if(fs.statSync(this.configPath).isFile())try{this.configContent=JSON.parse(fs.readFileSync(this.configPath,"utf-8"))}catch(e){console.error("Error occurred loading config!",e),process.exit(1)}},e}();exports.default=InitMiddleWare;